<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>MiniSheet Pro — Full Spreadsheet</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
<style>
:root {
  --bg:#f5f5f5; --panel:#e0e0e0; --accent:#4b6cb7; --text:#333;
  --header:#d0d0d0; --border:#ccc; --hover:#cce0ff; --selected:#a0c4ff;
}
html,body{margin:0;padding:0;height:100%;font-family:sans-serif;background:var(--bg);color:var(--text);}
body{display:flex;justify-content:center;padding:20px;}
.app{width:1200px;max-width:95%;}
header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;}
h1{margin:0;font-size:20px;color:var(--accent);}
.toolbar, .sheet-wrap{background:var(--panel);padding:8px;border-radius:8px;margin-bottom:10px;}
.toolbar{display:flex;flex-wrap:wrap;gap:6px;align-items:center;}
.toolbar button,input[type=file],select{padding:6px 8px;border-radius:6px;border:1px solid var(--border);cursor:pointer;background:#fff;}
.sheet-wrap{overflow:auto;max-height:65vh;}
table.sheet{border-collapse:collapse;width:100%;table-layout:fixed;}
table.sheet th, table.sheet td{border:1px solid var(--border);padding:6px 8px;min-width:80px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
table.sheet th{background:var(--header);position:sticky;top:0;z-index:2;text-align:left;}
.row-header{background:var(--header);position:sticky;left:0;z-index:1;text-align:center;}
td[contenteditable="true"]{background:#fff;outline:none;}
td.selected{background:var(--selected);}
td.focused{outline:2px solid var(--accent);}
</style>
</head>
<body>
<div class="app">
<header>
<h1>MiniSheet Pro</h1>
<div class="small">Captain — Full-feature Spreadsheet</div>
</header>

<div class="toolbar">
<button id="newBtn">New</button>
<button id="addRowBtn">+Row</button>
<button id="addColBtn">+Col</button>
<button id="delRowBtn">DelRow</button>
<button id="delColBtn">DelCol</button>
<button id="undoBtn">Undo</button>
<button id="redoBtn">Redo</button>
<label>Bold<input type="checkbox" id="boldBtn"></label>
<label>Italic<input type="checkbox" id="italicBtn"></label>
<label>Underline<input type="checkbox" id="underlineBtn"></label>
<label>TextColor<input type="color" id="textColor"></label>
<label>BGColor<input type="color" id="bgColor"></label>
<input type="file" id="fileInput" accept=".xlsx,.xls,.csv" style="display:none"/>
<button id="importBtn">Import</button>
<button id="exportXlsxBtn">Export .xlsx</button>
<button id="exportCsvBtn">Export .csv</button>
</div>

<div class="sheet-wrap" id="sheetWrap"></div>
</div>

<script>
const DEFAULT_ROWS=20, DEFAULT_COLS=12;
let rows=DEFAULT_ROWS, cols=DEFAULT_COLS;
let undoStack=[], redoStack=[];
let selection={start:null,end:null};
const sheetWrap=document.getElementById('sheetWrap');

function colLetter(n){let s='';while(n>0){let r=(n-1)%26;s=String.fromCharCode(65+r)+s;n=Math.floor((n-1)/26);}return s;}

function buildTable(r=rows,c=cols,data=[]){
rows=r;cols=c;
const table=document.createElement('table');table.className='sheet';
const thead=document.createElement('thead');const headRow=document.createElement('tr');
const corner=document.createElement('th');corner.style.left='0';corner.className='row-header';headRow.appendChild(corner);
for(let j=1;j<=cols;j++){const th=document.createElement('th');th.textContent=colLetter(j);headRow.appendChild(th);}
thead.appendChild(headRow);table.appendChild(thead);
const tbody=document.createElement('tbody');
for(let i=0;i<rows;i++){
  const tr=document.createElement('tr');
  const rh=document.createElement('th');rh.className='row-header';rh.textContent=i+1;tr.appendChild(rh);
  for(let j=0;j<cols;j++){
    const td=document.createElement('td');td.contentEditable='true';td.dataset.r=i;td.dataset.c=j;
    if(data[i] && data[i][j]!==undefined) td.textContent=data[i][j];
    td.addEventListener('input',()=>{saveUndo({type:'edit',r:i,c:j,prev:data[i]&&data[i][j]?data[i][j]:'',newVal:td.textContent});});
    td.addEventListener('focus',()=>td.classList.add('focused'));
    td.addEventListener('blur',()=>td.classList.remove('focused'));
    td.addEventListener('mousedown',()=>startSelection(td));
    td.addEventListener('mouseenter',()=>updateSelection(td));
    tr.appendChild(td);
  }
  tbody.appendChild(tr);
}
table.appendChild(tbody);
sheetWrap.innerHTML='';sheetWrap.appendChild(table);
}

// Selection
function startSelection(td){selection.start=td;selection.end=td;clearSelected();updateSelected();}
function updateSelection(td){selection.end=td;clearSelected();updateSelected();}
function clearSelected(){sheetWrap.querySelectorAll('td.selected').forEach(td=>td.classList.remove('selected'));}
function updateSelected(){if(!selection.start || !selection.end) return;
const sr=Math.min(+selection.start.dataset.r,+selection.end.dataset.r);
const er=Math.max(+selection.start.dataset.r,+selection.end.dataset.r);
const sc=Math.min(+selection.start.dataset.c,+selection.end.dataset.c);
const ec=Math.max(+selection.start.dataset.c,+selection.end.dataset.c);
for(let i=sr;i<=er;i++){for(let j=sc;j<=ec;j++){sheetWrap.querySelector(`td[data-r="${i}"][data-c="${j}"]`).classList.add('selected');}}
}

// Undo/Redo
function saveUndo(action){undoStack.push(action);redoStack=[];}
function undo(){if(!undoStack.length) return; const a=undoStack.pop();redoStack.push(a);applyAction(a,true);}
function redo(){if(!redoStack.length) return; const a=redoStack.pop();undoStack.push(a);applyAction(a,false);}
function applyAction(a,reverse){const td=sheetWrap.querySelector(`td[data-r="${a.r}"][data-c="${a.c}"]`);if(a.type==='edit'){td.textContent=reverse?a.prev:a.newVal;}}

// Toolbar buttons
document.getElementById('newBtn').addEventListener('click',()=>buildTable(DEFAULT_ROWS,DEFAULT_COLS));
document.getElementById('addRowBtn').addEventListener('click',()=>addRow());
document.getElementById('addColBtn').addEventListener('click',()=>addCol());
document.getElementById('delRowBtn').addEventListener('click',()=>delRow());
document.getElementById('delColBtn').addEventListener('click',()=>delCol());
document.getElementById('undoBtn').addEventListener('click',()=>undo());
document.getElementById('redoBtn').addEventListener('click',()=>redo());

// Styling
document.getElementById('boldBtn').addEventListener('change',()=>applyStyle('fontWeight','bold',!document.getElementById('boldBtn').checked));
document.getElementById('italicBtn').addEventListener('change',()=>applyStyle('fontStyle','italic',!document.getElementById('italicBtn').checked));
document.getElementById('underlineBtn').addEventListener('change',()=>applyStyle('textDecoration','underline',!document.getElementById('underlineBtn').checked));
document.getElementById('textColor').addEventListener('input',()=>applyStyle('color',document.getElementById('textColor').value));
document.getElementById('bgColor').addEventListener('input',()=>applyStyle('backgroundColor',document.getElementById('bgColor').value));

function applyStyle(prop,value,revert=false){
  const tds=sheetWrap.querySelectorAll('td.selected');
  tds.forEach(td=>{td.style[prop]=revert?'':value;});
}

// Row/Col operations
function addRow(){rows+=1;buildTable(rows,cols,getGridData());}
function addCol(){cols+=1;buildTable(rows,cols,getGridData());}
function delRow(){if(rows<=1)return;rows-=1;buildTable(rows,cols,getGridData());}
function delCol(){if(cols<=1)return;cols-=1;buildTable(rows,cols,getGridData());}

// Copy/Paste
document.addEventListener('keydown',e=>{
if((e.ctrlKey||e.metaKey)&&e.key==='c'){copyCells();e.preventDefault();}
if((e.ctrlKey||e.metaKey)&&e.key==='v'){pasteCells();e.preventDefault();}
});
let clipboard=[];
function copyCells(){clipboard=[];const tds=sheetWrap.querySelectorAll('td.selected');tds.forEach(td=>{clipboard.push({r:+td.dataset.r,c:+td.dataset.c,content:td.textContent,style:td.getAttribute('style')});});}
function pasteCells(){if(!clipboard.length)return;
const start=sheetWrap.querySelector('td.selected');if(!start)return;
const sr=+start.dataset.r,sc=+start.dataset.c;
clipboard.forEach(c=>{
  const td=sheetWrap.querySelector(`td[data-r="${sr+(c.r-clipboard[0].r)}"][data-c="${sc+(c.c-clipboard[0].c)}"]`);
  if(td){td.textContent=c.content;td.setAttribute('style',c.style);saveUndo({type:'edit',r:+td.dataset.r,c:+td.dataset.c,prev:'',newVal:c.content});}
});
}

// Import XLSX/CSV
const fileInput=document.getElementById('fileInput');
document.getElementById('importBtn').addEventListener('click',()=>fileInput.click());
fileInput.addEventListener('change',handleFile,false);
function handleFile(evt){
const file=evt.target.files[0];if(!file)return;
const reader=new FileReader();
reader.onload=function(e){
  const data=e.target.result;
  const wb=XLSX.read(data,{type:'array'});
  const ws=wb.Sheets[wb.SheetNames[0]];
  const arr=XLSX.utils.sheet_to_json(ws,{header:1,raw:false});
  buildTable(arr.length,Math.max(...arr.map(r=>r.length)),arr);
};
reader.readAsArrayBuffer(file);evt.target.value='';
}

// Export
document.getElementById('exportXlsxBtn').addEventListener('click',()=>{
  const ws=XLSX.utils.aoa_to_sheet(getGridData());
  const wb=XLSX.utils.book_new();XLSX.utils.book_append_sheet(wb,ws,'Sheet1');
  XLSX.writeFile(wb,'minisheet.xlsx');
});
document.getElementById('exportCsvBtn').addEventListener('click',()=>{
  const ws=XLSX.utils.aoa_to_sheet(getGridData());
  const csv=XLSX.utils.sheet_to_csv(ws);
  const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'});const url=URL.createObjectURL(blob);
  const a=document.createElement('a');a.href=url;a.download='minisheet.csv';a.click();URL.revokeObjectURL(url);
});

// Utilities
function getGridData(){const table=sheetWrap.querySelector('table.sheet');if(!table)return[];const data=[];for(const tr of table.tBodies[0].rows){const row=[];for(const td of tr.cells){if(td.tagName==='TH')continue;row.push(td.textContent);}data.push(row);return data;}return data;}

buildTable(DEFAULT_ROWS,DEFAULT_COLS);
</script>
</body>
</html>